
# AntDesign

[1](https://www.jianshu.com/p/83703a6a0865)ã€
[å‡çº§åˆ°UMI4çš„é€‚é…æ–¹æ¡ˆ](https://juejin.cn/post/7273803674789527591)ã€

```
Error parsing bundle asset "/Users/xxx/dist/xxx.async.js": no such file
```

## å‡çº§åˆ° Umi 4

```
info  - [ä½ çŸ¥é“å—ï¼Ÿ] å¦‚æœè¦æ”¯æŒä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œå¯å°è¯•æ–°å‡ºçš„ legacy é…ç½®é¡¹ï¼Œè¯¦è§ https://umijs.org/blog/legacy-browser

Mako https://makojs.dev is a new fast Rust based bundler from us, which is heavily optimized for umi and much faster than webpack. Visit https://makojs.dev/docs/getting-started#bundle-with-umi for more details if you want to give it a try.

[ä½ çŸ¥é“å—ï¼Ÿ] å¦‚æœä½ æœ‰ MPAï¼ˆå¤šé¡µåº”ç”¨ï¼‰éœ€æ±‚ï¼Œå¯å°è¯•æ–°å‡ºçš„ mpa é…ç½®é¡¹ï¼Œè¯¦è§ https://umijs.org/docs/guides/mpa
Mako https://makojs.dev is a new fast Rust based bundler from us, which is heavily optimized for umi and much faster than webpack. Visit https://makojs.dev/docs/getting-started#bundle-with-umi for more details if you want to give it a try.

{
  "devDependencies": {
+   "@umijs/max": "^4.0.0",
-   "umi": "^3.0.0",
-   "@umijs/preset-react": "^1.2.2"
  }
}

åˆ é™¤ node_moduleï¼Œæ‰§è¡Œä¸‹ npm install é‡è£…ä¾èµ–ã€‚
```

Umi 4 é»˜è®¤æŒ‰é¡µæ‹†åŒ…ã€æŒ‰éœ€åŠ è½½ï¼ˆè¿™è¿‘ä¼¼ç­‰åŒäº Umi 3 ä¸­çš„ `dynamicImport`ï¼‰ï¼Œé€šè¿‡ `loading.tsx` æ¥è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»ã€‚

## åˆ†æ

```
ä¸€ä¸ªä¾èµ–è¢«é‡å¤æ‰“åŒ…æ˜¾ç„¶ä¼šé€ æˆæ‰“åŒ…äº§ç‰©çš„å†—ä½™ï¼Œå…¶å®ç†æƒ³æƒ…å†µä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™äº›ä¾èµ–åªè¢«æ‰“åŒ…ä¸€æ¬¡ï¼Œæ”¾åˆ°ä¸€ä¸ªå…¬å…±çš„æ–‡ä»¶ä¸­ï¼Œéœ€è¦ä½¿ç”¨å®ƒçš„é¡µé¢éƒ½å»å¼•ç”¨è¿™ä¸ªæ–‡ä»¶å°±å¥½äº†ã€‚
```

## å‘½ä»¤è¡Œ

> - COMPRESS=none umi build å¯ä»¥å…³é—­é¡¹ç›®æ„å»ºæ—¶çš„ä»£ç å‹ç¼©åŠŸèƒ½, æ–¹ä¾¿è°ƒè¯•é¡¹ç›®çš„æ„å»ºäº§ç‰©ã€‚
> - å¦‚æœè¦æ”¯æŒä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œå¯å°è¯•æ–°å‡ºçš„ [legacy](https://umijs.org/blog/legacy-browser) é…ç½®é¡¹ ã€‚

```sh
# https://umijs.org/docs/guides/env-variables#analyze
ANALYZE=1 umi dev
```

### deadcode

```
umi deadcode
```

### [plugin](https://umijs.org/docs/api/commands#plugin)

åˆ—å‡ºæ‰€æœ‰æ’ä»¶ã€‚

```txt
% umi plugin list
- @umijs/core/dist/service/servicePlugin
- @umijs/preset-umi (from preset)
- @umijs/preset-umi/dist/registerMethods (from preset)
- @umijs/did-you-know
- @umijs/preset-umi/dist/features/404/404 (from preset)
- @umijs/preset-umi/dist/features/appData/appData (from preset)
- @umijs/preset-umi/dist/features/appData/umiInfo (from preset)
- @umijs/preset-umi/dist/features/check/check (from preset)
- @umijs/preset-umi/dist/features/check/babel722 (from preset)
- @umijs/preset-umi/dist/features/codeSplitting/codeSplitting (from preset)
- @umijs/preset-umi/dist/features/configPlugins/configPlugins (from preset)
- virtual: config-title
- virtual: config-styles
- virtual: config-scripts
- virtual: config-routes
- virtual: config-routeLoader
- virtual: config-reactRouter5Compat
- virtual: config-presets
- virtual: config-plugins
- virtual: config-npmClient
- virtual: config-mountElementId
- virtual: config-metas
- virtual: config-links
- virtual: config-historyWithQuery
- virtual: config-history
- virtual: config-headScripts
- virtual: config-esbuildMinifyIIFE
- virtual: config-conventionRoutes
- virtual: config-conventionLayout
- virtual: config-base
- virtual: config-analyze
- virtual: config-writeToDisk
- virtual: config-theme
- virtual: config-targets
- virtual: config-svgr
- virtual: config-svgo
- virtual: config-stylusLoader
- virtual: config-styleLoader
- virtual: config-srcTranspilerOptions
- virtual: config-srcTranspiler
- virtual: config-sassLoader
- virtual: config-runtimePublicPath
- virtual: config-purgeCSS
- virtual: config-publicPath
- virtual: config-proxy
- virtual: config-postcssLoader
- virtual: config-outputPath
- virtual: config-normalCSSLoaderModules
- virtual: config-mfsu
- virtual: config-mdx
- virtual: config-manifest
- virtual: config-lessLoader
- virtual: config-jsMinifierOptions
- virtual: config-jsMinifier
- virtual: config-inlineLimit
- virtual: config-ignoreMomentLocale
- virtual: config-https
- virtual: config-hash
- virtual: config-forkTSChecker
- virtual: config-fastRefresh
- virtual: config-extraPostCSSPlugins
- virtual: config-extraBabelPresets
- virtual: config-extraBabelPlugins
- virtual: config-extraBabelIncludes
- virtual: config-externals
- virtual: config-esm
- virtual: config-devtool
- virtual: config-depTranspiler
- virtual: config-define
- virtual: config-deadCode
- virtual: config-cssPublicPath
- virtual: config-cssMinifierOptions
- virtual: config-cssMinifier
- virtual: config-cssLoaderModules
- virtual: config-cssLoader
- virtual: config-copy
- virtual: config-checkDepCssModules
- virtual: config-chainWebpack
- virtual: config-cacheDirectoryPath
- virtual: config-babelLoaderCustomize
- virtual: config-autoprefixer
- virtual: config-autoCSSModules
- virtual: config-alias
- @umijs/preset-umi/dist/features/crossorigin/crossorigin (from preset)
- @umijs/preset-umi/dist/features/depsOnDemand/depsOnDemand (from preset)
- @umijs/preset-umi/dist/features/devTool/devTool (from preset)
- @umijs/preset-umi/dist/features/esbuildHelperChecker/esbuildHelperChecker (from preset)
- @umijs/preset-umi/dist/features/esmi/esmi (from preset)
- @umijs/preset-umi/dist/features/exportStatic/exportStatic (from preset)
- @umijs/preset-umi/dist/features/favicons/favicons (from preset)
- @umijs/preset-umi/dist/features/helmet/helmet (from preset)
- @umijs/preset-umi/dist/features/icons/icons (from preset)
- @umijs/preset-umi/dist/features/mock/mock (from preset)
- @umijs/preset-umi/dist/features/mpa/mpa (from preset)
- @umijs/preset-umi/dist/features/okam/okam (from preset)
- @umijs/preset-umi/dist/features/overrides/overrides (from preset)
- @umijs/preset-umi/dist/features/phantomDependency/phantomDependency (from preset)
- @umijs/preset-umi/dist/features/polyfill/polyfill (from preset)
- @umijs/preset-umi/dist/features/polyfill/publicPathPolyfill (from preset)
- @umijs/preset-umi/dist/features/prepare/prepare (from preset)
- @umijs/preset-umi/dist/features/routePrefetch/routePrefetch (from preset)
- @umijs/preset-umi/dist/features/terminal/terminal (from preset)
- @umijs/preset-umi/dist/features/tmpFiles/tmpFiles (from preset)
- @umijs/preset-umi/dist/features/clientLoader/clientLoader (from preset)
- @umijs/preset-umi/dist/features/routeProps/routeProps (from preset)
- @umijs/preset-umi/dist/features/ssr/ssr (from preset)
- @umijs/preset-umi/dist/features/tmpFiles/configTypes (from preset)
- @umijs/preset-umi/dist/features/transform/transform (from preset)
- @umijs/preset-umi/dist/features/lowImport/lowImport (from preset)
- @umijs/preset-umi/dist/features/vite/vite (from preset)
- @umijs/preset-umi/dist/features/apiRoute/apiRoute (from preset)
- @umijs/preset-umi/dist/features/monorepo/redirect (from preset)
- @umijs/preset-umi/dist/features/test/test (from preset)
- @umijs/preset-umi/dist/features/clickToComponent/clickToComponent (from preset)
- @umijs/preset-umi/dist/features/legacy/legacy (from preset)
- @umijs/preset-umi/dist/features/classPropertiesLoose/classPropertiesLoose (from preset)
- @umijs/preset-umi/dist/features/webpack/webpack (from preset)
- @umijs/preset-umi/dist/features/swc/swc (from preset)
- @umijs/preset-umi/dist/features/ui/ui (from preset)
- @umijs/preset-umi/dist/features/hmrGuardian/hmrGuardian (from preset)
- @umijs/preset-umi/dist/commands/build (from preset)
- @umijs/preset-umi/dist/commands/config/config (from preset)
- @umijs/preset-umi/dist/commands/dev/dev (from preset)
- @umijs/preset-umi/dist/commands/help (from preset)
- @umijs/preset-umi/dist/commands/lint (from preset)
- @umijs/preset-umi/dist/commands/setup (from preset)
- @umijs/preset-umi/dist/commands/deadcode (from preset)
- @umijs/preset-umi/dist/commands/version (from preset)
- @umijs/preset-umi/dist/commands/generators/page (from preset)
- @umijs/preset-umi/dist/commands/generators/prettier (from preset)
- @umijs/preset-umi/dist/commands/generators/tsconfig (from preset)
- @umijs/preset-umi/dist/commands/generators/jest (from preset)
- @umijs/preset-umi/dist/commands/generators/tailwindcss (from preset)
- @umijs/preset-umi/dist/commands/generators/dva (from preset)
- @umijs/preset-umi/dist/commands/generators/component (from preset)
- @umijs/preset-umi/dist/commands/generators/mock (from preset)
- @umijs/preset-umi/dist/commands/generators/cypress (from preset)
- @umijs/preset-umi/dist/commands/generators/api (from preset)
- @umijs/preset-umi/dist/commands/generators/precommit (from preset)
- @umijs/preset-umi/dist/commands/plugin (from preset)
- @umijs/preset-umi/dist/commands/verify-commit (from preset)
- @umijs/preset-umi/dist/commands/preview (from preset)
- @umijs/preset-umi/dist/commands/mfsu/mfsu (from preset)
- @umijs/plugin-run
- @umijs/core/dist/service/generatePlugin
- ./node_modules/@umijs/plugins/dist/dva
- ./node_modules/@umijs/plugins/dist/model
```

## MFSU

```sh
# highlight-next-line
% umi -h

Usage: umi <command> [options]

Commands:

    esbuildHelperCheckercheck esbuild helper conflicts
    build     build app for production
    config    umi config cli
    dev       dev server for development
    help      show commands help
    lint      lint source code using eslint and stylelint
    setup     setup project
    deadcode  check dead code
    version   show umi version
    v         show umi version
    plugin    inspect umi plugins
    verify-commitverify the commit message, which is usually used with husky.
    preview   locally preview production build
    mfsu      mfsu CLI util
    run       run the script commands, support for ts and zx
    generate  generate code snippets quickly
    g         generate code snippets quickly

Run `umi help <command>` for more information of specific commands.
Visit https://umijs.org/ to learn more about Umi.


# highlight-next-line
% umi mfsu -h

Usage: umi mfsu [options]
mfsu CLI util.

Details:
    # MFSU CLI util
    # umi mfsu [action]
    
    # Show Help
    $ umi mfsu
    
    # Manually build mfsu dependencies
    $ umi mfsu build
    $ umi mfsu b
    
    # list mfsu dependencies
    $ umi mfsu list
    $ umi mfsu ls
    
    # remove mfsu dependencies
    $ umi mfsu remove
    $ umi mfsu remove --all
```

## [ç‰©ç†ç¼“å­˜ chainWebpack](https://umijs.org/blog/webpack-5-prod-cache)


```ts
// å®˜æ–¹é…ç½®

// .umirc.ts
import { join } from 'path';
import { defineConfig } from 'umi';
import { createHash } from 'crypto';

export default defineConfig({
  chainWebpack(config, { env }) {
    if (env === 'production') {
      config.cache({
        type: 'filesystem',
        store: 'pack',
        // ğŸŸ¡ å‡å¦‚ä½ çš„é¡¹ç›®åœ¨ CI ä¸­æ„å»ºæ¯æ¬¡ç¯å¢ƒå˜é‡éƒ½ä¸ä¸€æ ·ï¼Œè¯·æŒ‘é€‰æˆ–è€…æ’é™¤
        version: createEnvironmentHash(process.env),
        buildDependencies: {
          config: [__filename],
          tsconfig: [join(__dirname, 'tsconfig.json')],
          packagejson: [join(__dirname, 'package.json')],
          umirc: [join(__dirname, '.umirc.ts')],
          // ğŸŸ¡ å…¶ä»–å¯èƒ½ä¼šå½±å“é¡¹ç›®çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå…¶å†…å®¹å˜æ›´ä¼šä½¿ç¼“å­˜å¤±æ•ˆ
        },
      });
    }
  },
});

function createEnvironmentHash(env: Record<string, any>) {
  const hash = createHash('md5');
  hash.update(JSON.stringify(env));
  const result = hash.digest('hex');
  return result;
}

// ç½‘ç»œèµ„æ–™
const config = {
  chainWebpack: (config) => {
// ç”Ÿäº§ç¯å¢ƒæ‰åˆ†åŒ…
    if (BUILD_ENV === 'production') {
      config.merge({
        optimization: {
          splitChunks: {
            chunks: 'all',
            minSize: 30000,
            minChunks: 3,
            automaticNameDelimiter: '.',
            cacheGroups: {
              vendor: {
                name: 'vendors',
                test({ resource }) {
                  return /[\\/]node_modules[\\/]/.test(resource);
                },
                priority: 10,
              },
            },
          },
        },
      });
    }
  }
  mfsu : {},
  webpack5: {},
}
// é…ç½®å®Œä¹‹åï¼Œåˆ é™¤ src/.umi ç›®å½•é‡æ–°å¯åŠ¨ umi dev
// rm -rf dist && rm -rf node_modules && rm -rf src/.umi && npm install
```



## mako

```sh
# Then, add the mako field in your config file.
# highlight-next-line
npx umi config set mako {}

set config:mako on /Users/liushan/Documents/sparkly/sc-merchant/config/config.ts



```



```sh
.
â”œâ”€â”¬ @typescript-eslint/eslint-plugin 6.21.0
â”‚ â””â”€â”€ âœ• unmet peer @typescript-eslint/parser@"^6.0.0 || ^6.0.0-alpha": found 5.62.0
â”œâ”€â”¬ dva 2.5.0-beta.2
â”‚ â”œâ”€â”€ âœ• unmet peer react@"15.x || ^16.0.0-0": found 18.3.1
â”‚ â”œâ”€â”€ âœ• unmet peer react-dom@"15.x || ^16.0.0-0": found 18.3.1
â”‚ â””â”€â”¬ react-redux 5.1.2
â”‚   â””â”€â”€ âœ• unmet peer react@"^0.14.0 || ^15.0.0-0 || ^16.0.0-0": found 18.3.1
â””â”€â”¬ @umijs/max 4.3.20
  â””â”€â”¬ @umijs/plugins 4.3.20
    â”œâ”€â”¬ @ahooksjs/use-request 2.8.15
    â”‚ â””â”€â”€ âœ• unmet peer react@"^16.8.0 || ^17.0.0": found 18.3.1
    â”œâ”€â”¬ react-intl 3.12.1
    â”‚ â””â”€â”€ âœ• unmet peer react@^16.3.0: found 18.3.1
    â””â”€â”¬ dva-loading 3.0.25
      â””â”€â”€ âœ• unmet peer dva-core@"^1.1.0 || ^1.5.0-0 || ^1.6.0-0": found 2.0.4

# highlight-next-line
pnpm config set auto-install-peers true
```


```sh
# highlight-next-line
% npx umi -v

umi@4.1.1

COMPRESS=none umi build å¯ä»¥å…³é—­é¡¹ç›®æ„å»ºæ—¶çš„ä»£ç å‹ç¼©åŠŸèƒ½, æ–¹ä¾¿è°ƒè¯•é¡¹ç›®çš„æ„å»ºäº§ç‰©ã€‚
```